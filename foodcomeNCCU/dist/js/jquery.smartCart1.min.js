$(document).ready(function () {


    var config = {
        apiKey: "AIzaSyCv65zJvID5FYHkNveKhoWv5bO8V5_jf5U",
        authDomain: "foodcomenccu-8a5b5.firebaseapp.com",
        databaseURL: "https://foodcomenccu-8a5b5.firebaseio.com",
        projectId: "foodcomenccu-8a5b5",
        storageBucket: "foodcomenccu-8a5b5.appspot.com",
        messagingSenderId: "77228063107",
        appId: "1:77228063107:web:12a0f04637dd293ad15eb6"

    };


    var defaultProject = firebase.initializeApp(config);

    var db = defaultProject.firestore();
    var url = location.href;
    var store = [];
    var classList
    var nameList



    if (url.includes("/res")) {
        var r = url.split("/res");

        var res = r[1]



        var temp = r[0].split("?");



        name = decodeURIComponent(temp[1])
        // alert(name)

    } else {
        var temp = url.split("?");


        name = decodeURIComponent(temp[1])



    }
    var order_key = [];
    var order = [];
    console.log('name', name)
    db.collection('store').get().then(function (querySnapshot) {
        querySnapshot.forEach(function (doc) {
            store.push(doc.data());
        });

        classList = store.map(item => Object.values(item)[1]);
        foodList = store.map(item => Object.values(item)[1]);
        nameList = store.map(item => Object.values(item)[4]);
        addList = store.map(item => Object.values(item)[0]);
        noList = store.map(item => Object.values(item)[5]);
        ratingList = store.map(item => Object.values(item)[6]);
        timeList = store.map(item => Object.values(item)[7]);
        // console.log('obj', typeof (nameList), nameList)

        var url = location.href;


        if (url.includes("/res")) {
            var r = url.split("/res");

            var res = r[1]

            var temp = r[0].split("?");

            name = decodeURIComponent(temp[1])
            var res1 = res.split(',')
            console.log('name', name, typeof (name), 'res', res)


            console.log('res1', res1, typeof (res1))

            res1.forEach(function (element) {
                element = (parseInt(element, 10))
                // alert(nameList[element])
                console.log('element', element, nameList[element], classList[element], timeList[element])
                
                $('#newstore').append('<div class="col-md-3 col-sm-4 col-xs-12" id=' + noList[element] + '><div class="tv-dishes-img"><img src="images/' + nameList[element] + '.jpg" class="width-100 img-responsive"></div><div class="tv-dishes-info"><h5>' + nameList[element] + '</h5><span>' + classList[element] + '</span><p>' + timeList[element] + '</p></div></div>')
            });


        } else {
            var temp = url.split("?");


            name = decodeURIComponent(temp[1])
            console.log('name', name, typeof (name), 'res', res)

        }




        $("#search").on("keydown", function (e) {


            if (event.which == 13) {

                var value = $(this).val();
                var searchstr = value;
                console.log('searchstr', searchstr)
                var searcharr = searchstr.split('');
                var reg = new RegExp(searcharr.join('.*'));
                var resultarr = new Array();
                // alert(value)
                for (var i = 0; i < nameList.length; i++) {
                    if (reg.exec(nameList[i])) {
                        if (resultarr.includes(nameList[i]) == false) {
                            // resultarr.push(nameList[i]);
                            console.log(nameList[i])
                            if (resultarr.length < 8 && resultarr.includes(i) == false) {
                                resultarr.push(i);
                            }

                        }
                    }
                }
                for (var i = 0; i < classList.length; i++) {
                    if (reg.exec(classList[i])) {
                        if (resultarr.includes(classList[i]) == false) {
                            // resultarr.push(nameList[i]);
                            console.log(nameList[i])
                            if (resultarr.length < 8 && resultarr.includes(i) == false) {
                                resultarr.push(i);
                            }

                        }

                    }
                }
                for (var i = 0; i < foodList.length; i++) {
                    if (reg.exec(classList[i])) {
                        if (resultarr.includes(foodList[i]) == false) {
                            // resultarr.push(nameList[i]);
                            console.log(nameList[i])
                            if (resultarr.length < 8 && resultarr.includes(i) == false) {
                                resultarr.push(i);
                            }
                        }

                    }
                }
                console.log('resultarr', resultarr);
                window.location = '../store.html?' + name + '/res' + resultarr;






            }



        });





    });

    
    db.collection(name).get().then(function (querySnapshot) {
        querySnapshot.forEach(function (doc) {
            order_key.push(doc.id)
            order.push(doc.data());

        });
      
        const no = order_key.map(item => Object.values(item)[0]);
        
        const day = order.map(item => Object.values(item)[1]);
        const smart = order.map(item => Object.values(item)[5]);

        const storename = order.map(item => Object.values(item)[6]);
        const totoprice = order.map(item => Object.values(item)[7]);
        console.log('order',storename)
        if (no.length == 0) {
            alert('尚未成立過訂單')
            window.location.href = '../../landingPage.html?' + name

        }
        // console.log('smart',typeof(smart),smart)

        no.forEach(function (element) {
            element = (parseInt(element, 10) - 1)
            // console.log('element',element)

            $('#row').append('<div class="col-md-4 col-sm-6" name="p1" "><div class="sc-product-item thumbnail"><div class="caption"><h4 data-name="order_no">訂單  ' + no[element] + '</h4><hr class="line"><label>店家</label><label name="order_store" class="form-control input-sm">' + storename[element] + '</label><label>訂單日期</label><label name="product_day" class="form-control input-sm">' + day[element] + '</label><label>價錢</label><label name="order_price" class="form-control input-sm">' + totoprice[element] + '</label><button class="sc-add-to-cart btn btn-success btn-sm pull-right" id="dital" name="' + element + '">詳細</button><div class="clearfix"></div></div></div></div>')

            $('button[name=' + element + ']').click(function () {
                console.log(typeof(smart[element]))

                var s2 = smart[element].replace('<button class="btn btn-info sc-cart-checkout" id="btn btn-info sc-cart-checkout" type="button">Checkout</button> <button class="btn btn-danger sc-cart-clear" id="btn btn-danger sc-cart-clear" type="button">Clear</button></div></div></div>', "")
                var s3 =s2.replace('<button type="button" class="sc-cart-remove" id="sc-cart-remove">×</button>', "")
                var s4 = s3.replace('input', "p")

                
                console.log('s3', s3 + 'sm')
                console.log('s4', s4 + 'sm')

                $('aside.col-md-4').html("'" + s4 + "'")
                
                
                $( "#sc-cart-remove" ).remove();
                $( "#sc-cart-remove" ).remove();
                $( "#addr" ).remove();
                $( "#pay1" ).remove();
                

            })


        });


    });


});